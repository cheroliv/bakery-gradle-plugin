= Bakery Gradle Plugin
:toc: left
:toclevels: 3
:source-highlighter: rouge

link:README_fr.adoc[Version FranÃ§aise]

== Overview

Bakery is a Gradle plugin designed to simplify the deployment of static websites generated by https://jbake.org[JBake] directly to GitHub Pages. It uses the https://github.com/eclipse/jgit[JGit] library to handle Git operations, allowing for a seamless deployment process from your build environment.

== Live Demo

A live demonstration of a static site deployed using this plugin is available here:

https://pages-content.github.io/bakery/

== Prerequisites

Before you begin, ensure you have the following installed:

*   A JDK (Java Development Kit), version 11 or higher.
*   The https://sdkman.io/[SDKMAN!] tool.
*   JBake, installed via SDKMAN!:
+
[source,bash]
----
sdk install jbake
----

== Quick Start

=== 1. Initialize a JBake Template

If you are starting a new project, you first need to create a JBake site structure. JBake provides a command to generate a sample template (e.g., `freemarker`).

[source,bash]
----
# This will create the assets, content, and templates folders in the "site" directory
jbake -i -t thymeleaf site
----

NOTE: You can also retrieve the `site` and `maquette` directories from the GitHub repository (https://github.com/cheroliv/bakery-gradle-plugin) or by downloading the zipped version directly from this link: https://github.com/cheroliv/bakery-gradle-plugin/archive/refs/heads/main.zip. Add these directories to the root directory where the Bakery plugin is used.

Your static content, templates, and assets will be placed in this `site` directory, which contains the `jbake.properties` file used by jbake.

=== 2. Create the Local Server Script

For local development, it's convenient to have a script to run the JBake development server. Create a file named `jbake.sh` at the root of your project with the following content:

.jbake.sh
[source,bash]
----
#!/usr/bin/env bash
jbake -b -s site build/jbake/;
----

Make the script executable:

[source,bash]
----
chmod +x jbake.sh
----

You can now run `./jbake.sh` to preview your site locally at `http://localhost:8820`.

== Plugin Configuration

To use the Bakery plugin, you need to configure it in your `build.gradle.kts` file. The configuration is straightforward and relies on a single YAML file to manage all deployment settings.

=== 1. Configure Plugin Resolution

In your `settings.gradle.kts` file, specify that Gradle should search for plugins on the Gradle Plugin Portal.

.settings.gradle.kts
[source,kotlin]
----
rootProject.name = "your-project-name"

pluginManagement {
    repositories {
        gradlePluginPortal()
    }
}
----

=== 2. Apply and Configure the Plugin

Now, apply the plugin in your `build.gradle.kts` and point it to your YAML configuration file.

.build.gradle.kts
[source,kotlin]
----
plugins {
    // Apply the plugin
    id("com.cheroliv.bakery") version "0.0.2"
}

// Configure the path to your YAML settings file
bakery {
    configPath.set(file("site.yml").absolutePath)
}
----

=== 3. Create the Configuration File

Create a YAML file (e.g., `site.yml`) at the root of your project. This file centralizes all the necessary information for deployment.

.site.yml
[source,yaml]
----
# JBake settings
bake:
  # Source directory for JBake content, assets, and templates
  srcPath: "site"
  # Destination directory for the generated site
  destDirPath: "bake"
  # (Optional) The domain for the CNAME file. If provided, a CNAME file will be created.
  cname: "www.your-domain.com"

# Deployment settings for the main static site
pushPage:
  # (Optional) Source directory for the push, relative to the build directory. Defaults to destDirPath.
  from: "bake"
  # (Optional) Target directory within the cloned repository. Defaults to the root.
  to: "cvs"
  # Git repository details
  repo:
    # A local identifier for the repository
    name: "my-static-site"
    # The URI of your GitHub repository
    repository: "https://github.com/YourUsername/YourRepository.git"
    # Credentials for authentication
    credentials:
      username: "YourUsername"
      # IMPORTANT: Use an environment variable or secret for the token
      password: "${GITHUB_TOKEN:-your_github_pat}"
  # The branch to deploy the site to
  branch: "gh-pages"
  # The commit message for the deployment
  message: "Deploying static site"

# Deployment settings for a secondary asset, like a wireframe/maquette
pushMaquette:
  # Source directory for the maquette, relative to the project root
  from: "maquette"
  # (Optional) Target directory within the cloned repository. Defaults to the root.
  to: "cvs"
  repo:
    name: "my-maquette"
    repository: "https://github.com/YourUsername/MaquetteRepository.git"
    credentials:
      username: "YourUsername"
      password: "${GITHUB_TOKEN:-your_github_pat}"
  branch: "main"
  message: "Deploying maquette"
----

=== Security Note

*IMPORTANT: Do not hardcode your GitHub Personal Access Token (PAT) directly in your configuration file.* It is highly recommended to use environment variables or GitHub Secrets to supply the token during the build process, as shown in the `githubToken` example above. This prevents your credentials from being exposed in your source code.


== Usage

The plugin provides two main tasks to deploy your content, configured via your `site.yml` file.

=== Deploying the JBake Site (`publishSite`)

This is the primary task for deploying your static site generated by JBake. It uses the configuration under the `pushPage` key in your YAML file.

To execute it, run the following command:
[source,bash]
----
./gradlew publishSite
----

This task will:
. Run JBake to build your static site into the `build/jbake` directory.
. Clone the specified branch from your GitHub repository.
. Copy the generated site files into the cloned repository.
. Commit and push the changes to GitHub Pages.

=== Deploying a Maquette (`publishMaquette`)

This task allows you to quickly publish a preliminary design or wireframe (a "maquette") before it has been sliced and integrated into JBake templates. It's perfect for design previews and validation cycles. This task uses the configuration under the `pushMaquette` key in your YAML file.

A live example of a deployed maquette is available here: https://pages-content.github.io/cheroliv-maquette/

To execute it, run the following command:
[source,bash]
----
./gradlew publishMaquette
----
This task will copy the contents of the source directory (e.g., `maquette/`) and deploy them to the configured repository and branch.

== Continuous Integration (CI) with GitHub Actions

This project includes a GitHub Actions workflow defined in `.github/workflows/website.yml` to automatically deploy the website whenever changes are pushed to the `main` branch.

To make this workflow operational, you must configure a repository secret.

=== Secret Configuration

The continuous integration process requires a GitHub Secret named `CHEROLIV_MIGRATION_CONFIG`. The content of this secret must be the same as your `site.yml` configuration file. The workflow uses this secret to generate the `site.yml` file needed by the `publishSite` task at runtime.

Follow these steps to create the secret:

1.  Navigate to your GitHub repository.
2.  Go to **Settings** > **Secrets and variables** > **Actions**.
3.  Click on the **New repository secret** button.
4.  For the **Name**, enter `CHEROLIV_MIGRATION_CONFIG`.
5.  For the **Secret**, copy and paste the entire content of your local `site.yml` file.
6.  Click **Add secret**.

Once the secret is configured, the CI will be able to authenticate and deploy your site automatically.

== License

This project is licensed under the Apache License, Version 2.0.